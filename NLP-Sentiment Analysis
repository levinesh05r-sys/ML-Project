import tensorflow as tf
import numpy as np
import pandas as pd
from tensorflow.keras.models import Sequential,load_model
from tensorflow.keras.layers import Embedding,LSTM,Dense,Dropout
from tensorflow.keras.preprocessing.text import Tokenizer
from tensorflow.keras.preprocessing.sequence import pad_sequences
from tensorflow.keras.datasets import imdb
from sklearn.metrics import confusion_matrix,classification_report
import matplotlib.pyplot as plt
import os

num_words=10000
max_len=200

(x_train,y_train),(x_test,y_test)=imdb.load_data(num_words=num_words)

word_index=imdb.get_word_index()
index_word={v+3:k for k,v in word_index.items()}
index_word[0]="<PAD>"
index_word[1]="<START>"
index_word[2]="<UNK>"

def decode(review):
    return " ".join([index_word.get(i,"?") for i in review])

train_text=[decode(x) for x in x_train[:1000]]
test_text=[decode(x) for x in x_test[:500]]

tokenizer=Tokenizer(num_words=num_words)
tokenizer.fit_on_texts(train_text)

x_train_seq=tokenizer.texts_to_sequences(train_text)
x_test_seq=tokenizer.texts_to_sequences(test_text)

x_train_pad=pad_sequences(x_train_seq,maxlen=max_len)
x_test_pad=pad_sequences(x_test_seq,maxlen=max_len)

y_train_small=y_train[:1000]
y_test_small=y_test[:500]

model_path="sentiment_model.h5"

if os.path.exists(model_path):
    model=load_model(model_path)
else:
    model=Sequential()
    model.add(Embedding(num_words,128,input_length=max_len))
    model.add(LSTM(128,return_sequences=True))
    model.add(LSTM(64))
    model.add(Dropout(0.3))
    model.add(Dense(1,activation="sigmoid"))
    model.compile(optimizer="adam",loss="binary_crossentropy",metrics=["accuracy"])
    history=model.fit(x_train_pad,y_train_small,epochs=4,batch_size=64,validation_data=(x_test_pad,y_test_small))
    model.save(model_path)
    plt.plot(history.history["accuracy"])
    plt.plot(history.history["val_accuracy"])
    plt.savefig("nlp_accuracy.png")
    plt.close()

loss,acc=model.evaluate(x_test_pad,y_test_small)
print("Test Accuracy:",acc*100)

preds=model.predict(x_test_pad)
pred_labels=(preds.flatten()>0.5).astype(int)

cm=confusion_matrix(y_test_small,pred_labels)
print("Confusion Matrix")
print(cm)

print("Classification Report")
print(classification_report(y_test_small,pred_labels))

while True:
    text=input("Enter a movie review: ")
    seq=tokenizer.texts_to_sequences([text])
    pad=pad_sequences(seq,maxlen=max_len)
    pred=model.predict(pad)[0][0]
    if pred>0.5:
        print("Sentiment: Positive")
    else:
        print("Sentiment: Negative")
    ch=input("Check another? (y/n): ")
    if ch.lower()!="y":
        break
